<!DOCTYPE html>
<html lang="es">
<head>
ย ย <meta charset="UTF-8">
ย ย <title>Panel de Administraciรณn</title>
ย ย <style>
ย ย ย ย body { font-family: 'Georgia', serif; margin: 0; background-color: #f8f9fa; color: #343a40; line-height: 1.6; }
ย ย ย ย .container { max-width: 1000px; margin: 50px auto; padding: 30px; background-color: #ffffff; border: 1px solid #e9ecef; border-radius: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
ย ย ย ย h2 { text-align: center; color: #495057; font-size: 2rem; margin-bottom: 5px; }
ย ย ย ย p { text-align: center; color: #6c757d; margin-top: 0; }
ย ย ย ย #loader { text-align: center; font-size: 1rem; color: #007bff; margin-bottom: 25px; }
ย ย ย ย .toolbar { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid #e9ecef; margin-bottom: 25px; flex-wrap: wrap; gap: 10px; }
ย ย ย ย .toolbar label { font-weight: 600; color: #495057; }
ย ย ย ย .toolbar select, .toolbar button { padding: 10px 15px; border: 1px solid #ced4da; border-radius: 4px; font-size: 0.9rem; cursor: pointer; transition: all 0.2s ease-in-out; }
ย ย ย ย .toolbar select { background-color: #ffffff; }
ย ย ย ย .toolbar button { background-color: #28a745; color: white; border: none; }
ย ย ย ย .toolbar button:hover { background-color: #218838; }
ย ย ย ย table { width: 100%; border-collapse: collapse; margin-top: 25px; font-size: 0.9rem; }
ย ย ย ย th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #dee2e6; }
ย ย ย ย th { background-color: #e9ecef; color: #495057; font-weight: bold; text-transform: uppercase; }
ย ย ย ย tr:hover { background-color: #f1f3f5; }
ย ย ย ย .duplicado { background-color: #dc3545 !important; color: white; }
ย ย ย ย .alerta-mantenimiento { background-color: #dc3545 !important; color: white; font-weight: bold; }
ย ย </style>
</head>
<body>
ย ย <div class="container">
ย ย ย ย <h2>Panel de Administraciรณn</h2>
ย ย ย ย <p>Visualiza y filtra los registros directamente:</p>

ย ย ย ย <div id="loader">โณ Cargando registros...</div>

ย ย ย ย <div class="toolbar">
ย ย ย ย ย ย <label>Filtro por Equipo:</label>
ย ย ย ย ย ย <select id="filtroEquipo" onchange="renderTable()">
ย ย ย ย ย ย ย ย <option value="">Todos</option>
ย ย ย ย ย ย ย ย <option value="Vehรญculo">Vehรญculo</option>
ย ย ย ย ย ย ย ย <option value="Maquinaria">Maquinaria</option>
ย ย ย ย ย ย </select>
ย ย ย ย ย ย <button onclick="descargarExcel()">๐ฅ Exportar a Excel</button>
ย ย ย ย </div>

ย ย ย ย <table id="tablaDatos"></table>
ย ย </div>

ย ย <script>
ย ย ย ย let registros = [];
ย ย ย ย const UMBRAL_ALERTA_KM = 5000;
ย ย ย ย let historialMantenimiento = {}; 

        // ๐จ LISTA DE REFERENCIA: KM Base de Mantenimiento por N.ECO ๐จ
        // Estos valores serรกn el punto de partida para la resta del KM recorrido
        const KM_BASE_MAINTENANCE = {
            "EQ-02": 165447,
            "EQ-32": 88866,
            "ET-67": 233344,
            "LL0023": 275553,
            "ET-57": 230826,
            "EQ-16": 99727,
            "ET-73": 272292,
            "ET-54": 236734,
            "ET-74": 261090,
            "EQ-17": 140681,
            "EQ-51": 26945,
            "EQ-55": 18866,
            "EA-49": 144210,
            "ECO-138": 139433,
            "ET-53": 286004,
            "EQ-23": 55352,
            "ET-55": 374301,
            "ET-66": 259651,
            "ET-36": 309436,
            "EQ-29": 116571,
            "ET-07": 56475,
            "EQ-38": 106242,
            "ET-64": 220211,
            "LL0002": 87137,
            "EA-44": 45211,
            // Nota: Se usarรก el รบltimo valor que proporcionaste para EQ-14, que es 4140
            "EQ-14": 4140, 
            "ET-01": 348730,
            "LL003": 277051,
            "EA-23": 595214
        };

ย ย ย ย async function cargarDatos() {
ย ย ย ย ย ย const url = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSuym_67YopJjYQDYPVorqZO8XubMbI7GKLexnpN7ST_M9ShAvZuSEOfcy3nTuuyNG6TaN_vvU1-ib0/pub?output=csv";
ย ย ย ย ย ย try {
ย ย ย ย ย ย ย ย const res = await fetch(url);
ย ย ย ย ย ย ย ย const text = await res.text();
ย ย ย ย ย ย ย ย 
                const rows = text.split("\n");
                registros = rows.map(row => row.split(","));
ย ย ย ย ย ย ย ย 
                // Primero se calcula la base de mantenimiento
ย ย ย ย ย ย ย ย calcularMantenimiento();
ย ย ย ย ย ย ย ย renderTable();

ย ย ย ย ย ย } catch (error) {
ย ย ย ย ย ย ย ย console.error("Error al cargar los datos:", error);
ย ย ย ย ย ย ย ย document.getElementById("loader").innerText = "โ Error al cargar los datos.";
ย ย ย ย ย ย } finally {
ย ย ย ย ย ย ย ย document.getElementById("loader").style.display = "none";
ย ย ย ย ย ย }
ย ย ย ย }

ย ย ย ย function calcularMantenimiento() {
ย ย ย ย ย ย // Inicializa el Map de rastreo que almacena el KM de referencia
ย ย ย ย ย ย const ultimoKm = new Map(); 

            // 1. Cargar los valores de Mantenimiento Base proporcionados por el usuario
            Object.entries(KM_BASE_MAINTENANCE).forEach(([serie, km]) => {
                ultimoKm.set(serie.toUpperCase(), km);
            });

ย ย ย ย ย ย // 2. Procesar los registros histรณricos
ย ย ย ย ย ย registros.forEach((fila, idx) => {
ย ย ย ย ย ย ย ย if (idx === 0) return; 
ย ย ย ย ย ย ย ย 
ย ย ย ย ย ย ย ย const equipo = (fila[1] || "").trim();
ย ย ย ย ย ย ย ย const serie = (fila[3] || "").trim().toUpperCase(); 
ย ย ย ย ย ย ย ย const kmActualStr = (fila[4] || "").trim(); 
ย ย ย ย ย ย ย ย const kmActual = parseFloat(kmActualStr);

ย ย ย ย ย ย ย ย if (equipo === 'Vehรญculo' && serie && !isNaN(kmActual) && kmActual > 0) {
                    // Obtiene el KM de referencia (serรก el de la lista base O el del registro anterior)
ย ย ย ย ย ย ย ย ย ย const kmAnterior = ultimoKm.get(serie) || 0;
                    
                    // Solo calculamos si el KM actual es mayor que el KM de referencia
                    if (kmActual >= kmAnterior) {
ย ย ย ย ย ย ย ย ย ย     const kmRecorridos = kmActual - kmAnterior;
ย ย ย ย ย ย ย ย ย ย 
ย ย ย ย ย ย ย ย ย ย     historialMantenimiento[idx] = {
ย ย ย ย ย ย ย ย ย ย ย ย     kmAnterior: kmAnterior,
ย ย ย ย ย ย ย ย ย ย ย ย     kmRecorridos: kmRecorridos,
                            alerta: kmRecorridos > UMBRAL_ALERTA_KM
ย ย ย ย ย ย ย ย ย ย     };
ย ย ย ย ย ย ย ย ย ย 
                        // Actualiza el Map con el KM actual para el siguiente cรกlculo de este N.ECO
ย ย ย ย ย ย ย ย ย ย     ultimoKm.set(serie, kmActual);
                    } else {
                        // El KM actual es menor que el de referencia (ej. error de captura o registro antiguo)
                        historialMantenimiento[idx] = { kmRecorridos: 0, alerta: false };
                    }
ย ย ย ย ย ย ย ย } else {
                    historialMantenimiento[idx] = { kmRecorridos: null, alerta: false };
                }
ย ย ย ย ย ย });
ย ย ย ย }

ย ย ย ย function renderTable() {
ย ย ย ย ย ย const tabla = document.getElementById("tablaDatos");
ย ย ย ย ย ย tabla.innerHTML = "";
ย ย ย ย ย ย const filtro = document.getElementById("filtroEquipo").value.toLowerCase();
ย ย ย ย ย ย const duplicados = new Map();

ย ย ย ย ย ย // Lรณgica original de Detecciรณn de Duplicados (se mantiene)
ย ย ย ย ย ย registros.forEach((fila, idx) => {
ย ย ย ย ย ย ย ย if (idx === 0) return;
ย ย ย ย ย ย ย ย const serie = (fila[3] || "").trim().toLowerCase();
ย ย ย ย ย ย ย ย const km = (fila[4] || "").trim().toLowerCase();
ย ย ย ย ย ย ย ย if (serie && km) {
ย ย ย ย ย ย ย ย ย ย const clave = serie + "-" + km;
ย ย ย ย ย ย ย ย ย ย duplicados.set(clave, (duplicados.get(clave) || []).concat(idx));
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย });

ย ย ย ย ย ย // 1. Cabecera con la nueva columna de cรกlculo
ย ย ย ย ย ย let headers = registros[0].slice(); 
ย ย ย ย ย ย headers.push("KM Recorridos desde รltimo Mantenimiento"); // Nueva etiqueta
ย ย ย ย ย ย const ths = headers.map(c => `<th>${c.trim()}</th>`).join("");
ย ย ย ย ย ย tabla.innerHTML += `<tr>${ths}</tr>`;

ย ย ย ย ย ย // 2. Cuerpo de la tabla
ย ย ย ย ย ย registros.forEach((fila, idx) => {
ย ย ย ย ย ย ย ย if (idx === 0) return;
ย ย ย ย ย ย ย ย if (filtro && (fila[1] || "").toLowerCase() !== filtro) return;

ย ย ย ย ย ย ย ย const serie = (fila[3] || "").trim().toLowerCase();
ย ย ย ย ย ย ย ย const km = (fila[4] || "").trim().toLowerCase();
ย ย ย ย ย ย ย ย const clave = serie + "-" + km;
ย ย ย ย ย ย ย ย const infoMantenimiento = historialMantenimiento[idx];
ย ย ย ย ย ย ย ย 
ย ย ย ย ย ย ย ย let rowHtml = "";
ย ย ย ย ย ย ย ย 
ย ย ย ย ย ย ย ย // Renderizar columnas originales
ย ย ย ย ย ย ย ย fila.forEach((celda, colIdx) => {
ย ย ย ย ย ย ย ย ย ย let clase = "";
ย ย ย ย ย ย ย ย ย ย if (duplicados.has(clave) && duplicados.get(clave).length > 1) {
ย ย ย ย ย ย ย ย ย ย ย ย if (colIdx === 3 || colIdx === 4) {
ย ย ย ย ย ย ย ย ย ย ย ย ย ย clase = "duplicado";
ย ย ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย ย ย rowHtml += `<td class="${clase}">${celda}</td>`;
ย ย ย ย ย ย ย ย });
ย ย ย ย ย ย ย ย 
ย ย ย ย ย ย ย ย // Renderizar la nueva columna calculada con la alerta
ย ย ย ย ย ย ย ย let valorKmRecorrido = '';
ย ย ย ย ย ย ย ย let claseCalculada = '';

ย ย ย ย ย ย ย ย if (infoMantenimiento && infoMantenimiento.kmRecorridos !== null) {
ย ย ย ย ย ย ย ย ย ย valorKmRecorrido = infoMantenimiento.kmRecorridos.toFixed(0);

ย ย ย ย ย ย ย ย ย ย if (infoMantenimiento.alerta) {
ย ย ย ย ย ย ย ย ย ย ย ย claseCalculada = 'alerta-mantenimiento';
ย ย ย ย ย ย ย ย ย ย ย ย valorKmRecorrido += " ๐จ"; 
ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย rowHtml += `<td class="${claseCalculada}">${valorKmRecorrido}</td>`;

ย ย ย ย ย ย ย ย tabla.innerHTML += `<tr>${rowHtml}</tr>`;
ย ย ย ย ย ย });
ย ย ย ย }

ย ย ย ย function descargarExcel() {
ย ย ย ย ย ย const sheetId = "1A4kCE2F9KcWYdRWFuMJV4gwEq_QP0tL0Rlp5V_YCIPI";ยย
ย ย ย ย ย ย const url = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=xlsx`;
ย ย ย ย ย ย window.open(url, "_blank");
ย ย ย ย }

ย ย ย ย cargarDatos();
ย ย </script>
</body>
</html>
ย ย ย ย function descargarExcel() {
ย ย ย ย ย ย const sheetId = "1A4kCE2F9KcWYdRWFuMJV4gwEq_QP0tL0Rlp5V_YCIPI";ยย
ย ย ย ย ย ย const url = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=xlsx`;
ย ย ย ย ย ย window.open(url, "_blank");
ย ย ย ย }

ย ย ย ย cargarDatos();
ย ย </script>
</body>
</html>



