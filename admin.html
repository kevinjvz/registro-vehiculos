<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Panel de Administraci√≥n</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        #loader { font-size: 18px; color: #555; margin-bottom: 12px; }
        .toolbar { display: flex; justify-content: flex-start; gap: 10px; margin-bottom: 12px; }
        table { border-collapse: collapse; width: 100%; margin-top: 15px; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
        th { background: #f4f4f4; }
        input, select { padding: 6px; }
        button { padding: 10px 20px; cursor: pointer; }
        .duplicado { background-color: red; color: white; }
    </style>
</head>
<body>
    <h2>Panel de Administraci√≥n</h2>
    <p>Visualiza y filtra los registros directamente:</p>

    <div id="loader">‚è≥ Cargando registros...</div>

    <div class="toolbar">
        <label>Filtro por Equipo:</label>
        <select id="filtroEquipo" onchange="renderTable()">
            <option value="">Todos</option>
            <option value="Veh√≠culo">Veh√≠culo</option>
            <option value="Maquinaria">Maquinaria</option>
        </select>
        <button onclick="descargarExcel()">üì• Exportar a Excel</button>
    </div>

    <table id="tablaDatos"></table>

    <script>
        let registros = [];

        async function cargarDatos() {
            const url = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSuym_67YopJjYQDYPVorqZO8XubMbI7GKLexnpN7ST_M9ShAvZuSEOfcy3nTuuyNG6TaN_vvU1-ib0/pub?output=csv";
            const res = await fetch(url);
            const text = await res.text();
            registros = text.split("\n").map(row => row.split(","));
            renderTable();
            document.getElementById("loader").style.display = "none";
        }

        function renderTable() {
            const tabla = document.getElementById("tablaDatos");
            tabla.innerHTML = "";
            const filtro = document.getElementById("filtroEquipo").value.toLowerCase();
            const duplicados = new Map();
            registros.forEach((fila, idx) => {
                if (idx === 0) return;
                const serie = (fila[3] || "").trim().toLowerCase();
                const km = (fila[4] || "").trim().toLowerCase();
                if (serie && km) {
                    const clave = serie + "-" + km;
                    if (duplicados.has(clave)) {
                        duplicados.set(clave, [...duplicados.get(clave), idx]);
                    } else {
                        duplicados.set(clave, [idx]);
                    }
                }
            });

            // Dibujar encabezados (con la nueva columna)
            const headers = registros[0];
            const ths = headers.map(c => `<th>${c}</th>`).join("") + "<th>Acciones</th>";
            tabla.innerHTML += `<tr>${ths}</tr>`;

            // Dibujar filas (con el bot√≥n de eliminar)
            registros.forEach((fila, idx) => {
                if (idx === 0) return;
                if (filtro && fila[1].toLowerCase() !== filtro) return;

                const serie = (fila[3] || "").trim().toLowerCase();
                const km = (fila[4] || "").trim().toLowerCase();
                const clave = serie + "-" + km;
                let rowHtml = "";
                fila.forEach((celda, colIdx) => {
                    let clase = "";
                    if (duplicados.has(clave) && duplicados.get(clave).length > 1) {
                        if (colIdx === 3 || colIdx === 4) {
                            clase = "duplicado";
                        }
                    }
                    rowHtml += `<td class="${clase}">${celda}</td>`;
                });
                // Agregar la celda del bot√≥n de eliminar
                rowHtml += `<td><button onclick="eliminarFila(${idx})">Eliminar</button></td>`;
                tabla.innerHTML += `<tr>${rowHtml}</tr>`;
            });
        }

        // Nueva funci√≥n para eliminar fila
        async function eliminarFila(rowIndex) {
            if (confirm("¬øEst√°s seguro de que quieres eliminar este registro?")) {
                const url = "https://script.google.com/macros/s/AKfycbwY4L_S2hR-5L8_z3n-Hn_k_zJ1h_K8H8w8S5P2s8R5z-Y_J_K2t8Y9d/exec"; // üëà Reemplaza con la URL de tu nuevo script
                const res = await fetch(url, {
                    method: "POST",
                    body: JSON.stringify({ rowIndex: rowIndex }),
                    headers: { "Content-Type": "application/json" }
                });
                const text = await res.text();
                if (text === "OK") {
                    alert("Registro eliminado exitosamente.");
                    cargarDatos(); // Recargar la tabla
                } else {
                    alert("Error al eliminar el registro: " + text);
                }
            }
        }

        function descargarExcel() {
            const sheetId = "1A4kCE2F9KcWYdRWFuMJV4gwEq_QP0tL0Rlp5V_YCIPI";
            const url = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=xlsx`;
            window.open(url, "_blank");
        }

        cargarDatos();
    </script>
</body>
</html>









