<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Panel de Administración</title>
    <style>
        body { font-family: 'Georgia', serif; margin: 0; background-color: #f8f9fa; color: #343a40; line-height: 1.6; }
        .container { max-width: 1000px; margin: 50px auto; padding: 30px; background-color: #ffffff; border: 1px solid #e9ecef; border-radius: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        h2 { text-align: center; color: #495057; font-size: 2rem; margin-bottom: 5px; }
        p { text-align: center; color: #6c757d; margin-top: 0; }
        #loader { text-align: center; font-size: 1rem; color: #007bff; margin-bottom: 25px; }
        .toolbar { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid #e9ecef; margin-bottom: 25px; flex-wrap: wrap; gap: 10px; }
        .toolbar label { font-weight: 600; color: #495057; }
        .toolbar select, .toolbar button { padding: 10px 15px; border: 1px solid #ced4da; border-radius: 4px; font-size: 0.9rem; cursor: pointer; transition: all 0.2s ease-in-out; }
        .toolbar select { background-color: #ffffff; }
        .toolbar button { background-color: #28a745; color: white; border: none; }
        .toolbar button:hover { background-color: #218838; }
        table { width: 100%; border-collapse: collapse; margin-top: 25px; font-size: 0.9rem; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #dee2e6; }
        th { background-color: #e9ecef; color: #495057; font-weight: bold; text-transform: uppercase; }
        tr:hover { background-color: #f1f3f5; }
        .duplicado { background-color: #dc3545 !important; color: white; }
        /* 🚨 NUEVA CLASE PARA LA ALERTA DE MANTENIMIENTO */
        .alerta-mantenimiento { background-color: #dc3545 !important; color: white; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h2>Panel de Administración</h2>
        <p>Visualiza y filtra los registros directamente:</p>

        <div id="loader">⏳ Cargando registros...</div>

        <div class="toolbar">
            <label>Filtro por Equipo:</label>
            <select id="filtroEquipo" onchange="renderTable()">
                <option value="">Todos</option>
                <option value="Vehículo">Vehículo</option>
                <option value="Maquinaria">Maquinaria</option>
            </select>
            <button onclick="descargarExcel()">📥 Exportar a Excel</button>
        </div>

        <table id="tablaDatos"></table>
    </div>

    <script>
        let registros = [];
        const UMBRAL_ALERTA_KM = 5000;
        let historialMantenimiento = {}; // Almacena {idx_fila: {kmRecorridos: number, alerta: boolean}}

        async function cargarDatos() {
            // URL de tu hoja de Google publicada como CSV
            const url = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSuym_67YopJjYQDYPVorqZO8XubMbI7GKLexnpN7ST_M9ShAvZuSEOfcy3nTuuyNG6TaN_vvU1-ib0/pub?output=csv";
            try {
                const res = await fetch(url);
                const text = await res.text();
                
                // Convertir el texto CSV a un arreglo de arreglos (filas y columnas)
                const rows = text.split("\n");
                registros = rows.map(row => row.split(","));
                
                // Ejecutar el cálculo antes de renderizar
                calcularMantenimiento();
                renderTable();

            } catch (error) {
                console.error("Error al cargar los datos:", error);
                document.getElementById("loader").innerText = "❌ Error al cargar los datos.";
            } finally {
                document.getElementById("loader").style.display = "none";
            }
        }

        function calcularMantenimiento() {
            // Map para rastrear el último KM registrado para cada N.ECO (Serie)
            const ultimoKm = new Map(); 

            registros.forEach((fila, idx) => {
                if (idx === 0) return; // Saltar cabecera
                
                const equipo = (fila[1] || "").trim();
                // Columna D: Número de Serie (N.ECO)
                const serie = (fila[3] || "").trim().toUpperCase(); 
                // Columna E: KM Actual
                const kmActualStr = (fila[4] || "").trim(); 
                const kmActual = parseFloat(kmActualStr);

                // Solo aplica la lógica a los 'Vehículo' con un N.ECO y un KM válido y mayor a 0
                if (equipo === 'Vehículo' && serie && !isNaN(kmActual) && kmActual > 0) {
                    // Obtiene el KM anterior (el último KM registrado para este N.ECO)
                    const kmAnterior = ultimoKm.get(serie) || 0;
                    
                    // CALCULO: Kilometraje Recorrido = KM Actual - KM Anterior
                    const kmRecorridos = kmActual - kmAnterior;
                    
                    // Almacena el resultado para esta fila
                    historialMantenimiento[idx] = {
                        kmAnterior: kmAnterior,
                        kmRecorridos: kmRecorridos,
                        // Alerta si supera el umbral de 5000 km
                        alerta: kmRecorridos > UMBRAL_ALERTA_KM
                    };
                    
                    // Actualiza el Map con el KM actual para que sirva de KM Anterior en el siguiente registro
                    ultimoKm.set(serie, kmActual);
                } else {
                    // Inicializa sin alerta para maquinaria o registros incompletos
                    historialMantenimiento[idx] = {
                        kmAnterior: null,
                        kmRecorridos: null,
                        alerta: false
                    };
                }
            });
        }

        function renderTable() {
            const tabla = document.getElementById("tablaDatos");
            tabla.innerHTML = "";
            const filtro = document.getElementById("filtroEquipo").value.toLowerCase();
            const duplicados = new Map();

            // Lógica original de Detección de Duplicados (se mantiene)
            registros.forEach((fila, idx) => {
                if (idx === 0) return;
                const serie = (fila[3] || "").trim().toLowerCase();
                const km = (fila[4] || "").trim().toLowerCase();
                if (serie && km) {
                    const clave = serie + "-" + km;
                    duplicados.set(clave, (duplicados.get(clave) || []).concat(idx));
                }
            });

            // 1. Cabecera con la nueva columna de cálculo
            let headers = registros[0].slice(); 
            headers.push("KM Recorridos desde Último Reg."); 
            const ths = headers.map(c => `<th>${c.trim()}</th>`).join("");
            tabla.innerHTML += `<tr>${ths}</tr>`;

            // 2. Cuerpo de la tabla
            registros.forEach((fila, idx) => {
                if (idx === 0) return;
                if (filtro && (fila[1] || "").toLowerCase() !== filtro) return;

                const serie = (fila[3] || "").trim().toLowerCase();
                const km = (fila[4] || "").trim().toLowerCase();
                const clave = serie + "-" + km;
                const infoMantenimiento = historialMantenimiento[idx];
                
                let rowHtml = "";
                
                // Renderizar columnas originales (manteniendo alerta de duplicados)
                fila.forEach((celda, colIdx) => {
                    let clase = "";
                    if (duplicados.has(clave) && duplicados.get(clave).length > 1) {
                        if (colIdx === 3 || colIdx === 4) {
                            clase = "duplicado";
                        }
                    }
                    rowHtml += `<td class="${clase}">${celda}</td>`;
                });
                
                // Renderizar la nueva columna calculada con la alerta
                let valorKmRecorrido = '';
                let claseCalculada = '';

                if (infoMantenimiento && infoMantenimiento.kmRecorridos !== null) {
                    // Muestra el KM redondeado
                    valorKmRecorrido = infoMantenimiento.kmRecorridos.toFixed(0);

                    if (infoMantenimiento.alerta) {
                        claseCalculada = 'alerta-mantenimiento';
                        valorKmRecorrido += " 🚨"; // Añade un ícono de alerta
                    }
                }
                rowHtml += `<td class="${claseCalculada}">${valorKmRecorrido}</td>`;

                tabla.innerHTML += `<tr>${rowHtml}</tr>`;
            });
        }

        function descargarExcel() {
            const sheetId = "1A4kCE2F9KcWYdRWFuMJV4gwEq_QP0tL0Rlp5V_YCIPI";  
            const url = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=xlsx`;
            window.open(url, "_blank");
        }

        cargarDatos();
    </script>
</body>
</html>


